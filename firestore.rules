rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Function to identify admin users
    function isAdmin() {
      let adminEmails = ['tumbikarthik2797@gmail.com','deepakperumal09@gmail.com'];
      return request.auth != null && request.auth.token.email in adminEmails;
    }

    // Function to check for essential booking data fields during creation
    function hasSufficientBookingDataForCreate(data) {
      return data.name != null && data.name is string &&
             data.email != null && data.email is string &&
             data.phone != null && data.phone is string &&
             data.serviceType != null && data.serviceType is string &&
             data.preferredDate != null && data.preferredDate is timestamp &&
             data.preferredTime != null && data.preferredTime is string &&
             data.userEmail != null && data.userEmail is string &&
             data.status != null && data.status is string &&
             data.bookedAt != null && // serverTimestamp will be a pending write, check for presence
             data.displayId != null && data.displayId is string;
    }

    // Users collection:
    match /users/{userId} {
      // An admin can read any user document. A user can only read their own.
      allow read: if isAdmin() || (request.auth != null && request.auth.uid == userId);
      // Only a user can create or update their own profile.
      allow create, update: if request.auth != null && request.auth.uid == userId;
    }
    
    // Service Bookings collection:
    match /serviceBookings/{bookingId} {
      allow create: if hasSufficientBookingDataForCreate(request.resource.data);
      allow read: if true;
      allow update: if true;
      // allow delete: if isAdmin();
    }

    match /serviceBookings/{document=**} {
      allow list: if true;
    }

    // Contact Submissions collection
    match /contactSubmissions/{submissionId} {
      // Allow any authenticated user to create a contact submission with basic validation.
      allow create: if request.auth != null &&
                       request.resource.data.name is string &&
                       request.resource.data.email is string &&
                       request.resource.data.message is string &&
                       (request.resource.data.subject == null || request.resource.data.subject is string) &&
                       request.resource.data.submittedAt == request.time;

      // Allow only admins to read or list contact submissions.
      allow read: if isAdmin();
    }
    
    match /contactSubmissions/{document=**} {
        allow list: if isAdmin();
    }
  }
}
